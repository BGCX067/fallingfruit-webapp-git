<div style="background: darkgrey;padding:0.5em;">
<div style="float: right;"><img src="/logo.png" height="40"></div>
<h1>The Falling Fruit Map</h1>
</div>
<br>
Regions: 
<% @regions.collect{ |region| %>
  <% if @type.nil? %>
    <a href="/locations?region_id=<%= region.id %>"><%= region.name %></a> |
  <% else %>
    <a href="/locations?type_id=<%= @type.id %>&region_id=<%= region.id %>"><%= region.name %></a> |
  <% end %>
<% } %>
<a href="/locations/">All</a>
<% unless @region.nil? %>
(Current Filter: <%= @region.name %>)
<% end %>
<br>
Types:
<% @types.collect{ |type| %>
  <% if @region.nil? %>
    <a href="/locations?type_id=<%= type.id %>"><%= type.name %></a> |
  <% else %>
    <a href="/locations?region_id=<%= @region.id %>&type_id=<%= type.id %>"><%= type.name %></a> |
  <% end %>
<% } %>
<a href="/locations/">All</a>
<% unless @type.nil? %>
(Current Filter: <%= @type.name %>)
<% end %>

<br><br>
<div>
<div id="recenter_button" style="text-align: right; width: 817px;">
<button onclick="recenter_map()">Zoom Map to My Location</button>
</div>
<%= gmaps4rails(@locations.to_gmaps4rails) %>
</div>
<br>
<table>
  <tr>
    <th>Author</th>
    <th>Title</th>
    <th>Description</th>
    <th>Season start</th>
    <th>Season stop</th>
    <th>Region</th>
    <th>Type</th>
    <th>Address</th>
    <th></th>
    <th></th>
    <% unless current_admin.nil? %>
      <th></th>
    <% end %>
  </tr>

<% @locations.each do |location| %>
  <tr>
    <td><%= location.author %></td>
    <td><%= location.title %></td>
    <td><%= location.description %></td>
    <td><%= location.season_start %></td>
    <td><%= location.season_stop %></td>
    <td><%= location.region.nil? ? "?" : location.region.name %></td>
    <td><%= location.type.nil? ? "?" : location.type.name %></td>
    <td><%= location.address %></td>
    <td><%= link_to 'Show', location %></td>
    <td><%= link_to 'Edit', edit_location_path(location) %></td>
    <% unless current_admin.nil? %>
      <td><%= link_to 'Destroy', location, method: :delete, data: { confirm: 'Are you sure?' } %></td>
    <% end %>
  </tr>
<% end %>
</table>

 <% content_for :scripts do %>
    <script type="text/javascript" charset="utf-8">
        function recenter_map(){
          navigator.geolocation.getCurrentPosition(function(position){
              var lat = position.coords.latitude;
              var lon = position.coords.longitude;
              loc = new google.maps.LatLng(lat,lon);
              Gmaps.map.serviceObject.panTo(loc);
              Gmaps.map.serviceObject.setZoom(14);
          },function(error){
            //use error.code to determine what went wrong
          });
        }
        if(!navigator.geolocation){
          $('recenter_button').hide();
        }
        navigator.geolocation.getCurrentPosition(function(position){},function(error){
          $('recenter_button').hide();
        });
        var markersArray = [];
        // On click, clear markers, place a new one, update coordinates in the form
        Gmaps.map.callback = function() {
            google.maps.event.addListener(Gmaps.map.serviceObject, 'click', function(event) {
              clearOverlays();
              placeMarker(event.latLng);
            });
        };
        // Add a marker with an open infowindow
        function placeMarker(latLng) {
            var marker = new google.maps.Marker({
                position: latLng, 
                map: Gmaps.map.serviceObject,
                draggable: true
            });
            markersArray.push(marker);
            // Set and open infowindow
            var infowindow = new google.maps.InfoWindow({
                content: '<a href="/locations/new?lat=' + latLng.lat() + '&lng=' + latLng.lng() + 
                         '">Click to add a source here</a><br>(You can drag this thing too)'
            });
            infowindow.open(Gmaps.map.serviceObject,marker);
            // Listen to drag & drop
            google.maps.event.addListener(marker, 'dragend', function() {
                var infowindow = new google.maps.InfoWindow({
                  content: '<a href="/locations/new?lat=' + this.getPosition().lat() +
                           '&lng=' + this.getPosition().lng() + '">Click to add a source here</a><br>(You can drag this thing too)'
                });
                infowindow.open(Gmaps.map.serviceObject,marker);
            });
        }
        // Removes the overlays from the map
        function clearOverlays() {
          if (markersArray) {
            for (var i = 0; i < markersArray.length; i++ ) {
              markersArray[i].setMap(null);
            }
          }
          markersArray.length = 0;
        }
    </script>
<% end %>
